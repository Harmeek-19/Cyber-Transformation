[ec2-user@ip-10-0-1-5 ~]$ TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s)
echo "=== AWS EC2 IMDSv2 Diagnostic ==="
echo "Token: ${TOKEN:0:20}..."
echo
echo "Instance ID:"
curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/instance-id
echo
echo "IAM Info:"
curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/info
echo
echo "Available Roles:"
ROLE_NAME=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/)
echo "Role: $ROLE_NAME"
echo
if [ -n "$ROLE_NAME" ]; then
    echo "Credentials:"
    curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME
    echo
fi
echo "AWS CLI Identity:"
aws sts get-caller-identity
echo
echo "S3 Test:"
aws s3 ls
=== AWS EC2 IMDSv2 Diagnostic ===
Token: AQAEANIWUFXBVwfgOCzW...

Instance ID:
i-0642aa798338cce4a
IAM Info:
{
  "Code" : "Success",
  "LastUpdated" : "2025-08-07T10:31:11Z",
  "InstanceProfileArn" : "arn:aws:iam::733366527973:instance-profile/iamroletestingec2s3",
  "InstanceProfileId" : "AIPA2VQANE7S342GWJYE2"
}
Available Roles:
Role: iamroletestingec2s3

Credentials:
{
  "Code" : "Success",
  "LastUpdated" : "2025-08-07T10:30:30Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "ASIA2VQANE7SW6J6AA6M",
  "SecretAccessKey" : "2OzzL4M187w2xnsLfF/tDkIu8/Mj4esffeiF/MeU",
  "Token" : "IQoJb3JpZ2luX2VjEFMaCXVzLWVhc3QtMSJIMEYCIQDOH4R3gffs+wHNpAz35GGnUyqojn953dD3uQ07jVgxawIhAPlw23VgJ5KS8C4R2M1DLj8Mekz84i7xOlae8GBCJABQKsAFCIz//////////wEQABoMNzMzMzY2NTI3OTczIgxfusRty8FoFpD6DAQqlAVcUtOgcv2IBiEA9KasWO4nz3+VvaEvnrB6jzKSBCF5eMmef65WTKga9vqe66eMWypdtbpOl26heRm7z/xKVQRTuui0EbxkKiy0o5S8IoCwp2v1ploN30uIH830Z8RX/Tkz/Pc7d/kWSJRzcM3jV4Hr1aN0WsBJC5aqdxibuMMvJ/2A9uj/no3X1mlbbWuu3yLZIHwGO/70kJxlJHxB1J5m1PlIzya8FhII+oVARj/Oi/D4D+qrThSMaprdlVJ0rCHZ1LldBzr7wmMZnKoyCurbALRyxYqYyVHwU/VT6vyHH019FHzhtS63ydtUkHe6hYllD2nRcJp5XzU5K/zUkyTQ01t/lP0N5kcLldfjR+ydFKeWn+bO7OpxhOCxAxJCpnVxAaRQETzasbA1qY4hWoDOy97pynZ+kHuI9RSdRT3CI3n3GuAvhM1gdHTKmtaLVc30uZyH/Wp55B9ACDK+4h1bQrRS23w/j54NOakObdFmZ+CejF9S4fv126qQXrM8U4ajgt2Uiar9NU4C0rnqXEASrj4ek7xSdpkZp1iodvDdzWBGZWYqoMK9cCcwH+hFidijPURHFJrH+VgEF8UMm8V74vkEkqEQRz1G2F0/a+DyM75wU51wJywtIa2WVGWWUd3F7JWP+3i3h59tQHqoI0dBBscmogJpqGEps+iy7QRO0nPc9bUmkc9guKZWHHy+6GvmA5IKRcfNr525hbAG3key/vPcYt/QZJu0oGaP57hdIAABCg4F+DQrFWuItDp7hfQtCovs654C/lxl5LZe6eIU+YwlqbXNYix3wZVPOSnuD3EC+m/P/OjzGt4q0jicky5hUh3VSj9E6k3HdODVNWsxlrEl+bIdyh3p+OaEMjHSM/5DMsIw74DSxAY6sAHBA3E1//JTTSAbuC/qVO5l3oswU+GeafZjDkguzJzjolB7IlKmR4o89435DMmlv5D/4eWl/K5IZjKc7Kl17MvpvBbJB+SXJ7WSkRWLiMoTG3VUp0fsEjh44e4Rird2p5zWhUTqYlrrqBRgVXo1+UBIEdhy1vky85ywMwJYJwlD+aUIS+4o9v8u4WniPsidg4v/B9/e2G8uqOyI+nvHMvnpmFbdItn0N1ehC/rb/RkWRQ==",
  "Expiration" : "2025-08-07T17:06:11Z"
}
AWS CLI Identity:
^C

S3 Test:
^C
[ec2-user@ip-10-0-1-5 ~]$
